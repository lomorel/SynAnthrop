---
title: "Calculation and application of the Species Synanthropy Index: tutorial"
author:
- Loïs Morel^[UMR DECOD, lois.morel@agrocampus-ouest.fr]
- Nadege Belouard^[UMR EcoBio, nadege.belouard@gmail.com]
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

This tutorial demonstrates:
- the calculation of the Species Synanthropy Index (SSI) and possible subsequent analyses and graphs, based on an example dataset of amphibian populations collected in western France
- the application of the SSI at the community scale, the Synanthropy Community Score (SCS) to estimate the overall sensitivity of assemblages to land use change.

We load necessary packages
```{r setup, warning = FALSE, message = FALSE}

library(SynAnthrop)
library(dplyr)
library(magrittr)
library(ggplot2)
```


# 1- Species Synanthropy Index: an example with amphibian populations in western France

## Setup

Two types of data are required to run the SSI function: (i) a raster describing the spatial gradient of anthropogenization of the region to be analysed, and (ii) a database of species occurrences, with XY coordinates and corresponding sampling dates.


The raster map used here is extracted from the French Naturalness Map, developed by [Guetté et al.(2021)](https://uicn.fr/CartNat/CartNat_Donnees/Note_technique_m%C3%A9thodologique/Projet%20CARTNAT_note%20technique_2021.pdf) and cropped to the region of interest, Brittany. You can download the cropped map at [url]. Place it in the `data/amphibiansBrittany` folder.

```{r load spatial data}

# load the raster file
ras_raw <- raster::raster(file.path(here::here(), 
                                    "data", 
                                    "amphibiansBrittany", 
                                    "naturalnessMap.tif"))

# create an object to visualize the raster
rast_to_plot <- terra::rast(ras_raw)
```

Next, we load the occurrence data to be evaluated, and take a look at the structure required for the analysis. Note that sampling years need to correspond to the years used to build the naturalness map for the analysis to make the most sense.

```{r load occurrence data}

# load the CSV file
spOcc <- read.csv(file.path(here::here(), 
                                    "data", 
                                    "amphibiansBrittany", 
                                    "amphibianOccurrences.csv"), 
                          sep = ";", h=T)

# look at data structure
head(spOcc)
```

The table contains one row per species, site and year sampled, with a total of 5 columns: species detected, sampling year, abundance detected, and geographic coordinates (X,Y). We make sure that all rows contain geographic coordinates.

```{r coordinate system checks}

# eliminate points with missing coordinates
missingcoord <- dim(spOcc %>% filter(is.na(Y) | is.na(Y)))[1]
spOcc %<>% filter(!is.na(Y) | !is.na(Y))
print(paste(missingcoord, "point(s) were eliminated because of missing coordinates"))
```

At this point, it is useful to plot the data to make sure the two datasets use the same coordinate system and everything looks as expected.

```{r plot map, fig.width = 10}

ggplot() + 
  tidyterra::geom_spatraster(data = rast_to_plot) +
  geom_point(data = spOcc, aes(x = X, y = Y, color = Year)) +
  scale_colour_gradient(labels = function(x) sprintf("%.0f", x),
                        low = "darkgray", high = "black") +
  tidyterra::scale_fill_whitebox_c(palette = "muted", direction= -1,
                                   breaks = c(100, 325, 550),
                                   labels = c("Low", "Medium", "High"),
                                   name = "Naturalness")
```


## SSI calculation

The function was designed to calculate SSI automatically from a data set (for a taxon, a territory and a period). Several raster resolutions can be evaluated in a row.

A null distribution is generated by randomly selecting sites within the species range. The effect of the studied gradient is measured by the effect size between the simulated and the observed species distributions, repeated n times. A synanthropy score, the SSI is assigned to each species based on the average difference between the null and observed distributions (from 1 to 10).

Here, we execute the function for 3 resolutions (100, 200, 250), with 500 simulations each. Each species must have been found in a minimum of 30 cells to be evaluated (threshold argument).
You will be prompted to validate the species list detected in the dataset. Make sure that there are no typos or synonyms, as each species will be considered separately for the analyses. A warning message may pop up but will not influence the process. 

```{r execute ssi function}

ssi_results <- ssi(r = ras_raw, 
                   resolution = c(100, 200, 250),
                   data = spOcc,  
                   sim = 500, 
                   threshold = 30)

```


## Visualise and analyse the SSI results

The SSI function produces 3 data frames.


### SSI and effect sizes per species

The first table contains the SSI calculated per species and resolution. It is a summary table containing one line per species per resolution, with the mean effect size, the number of simulations, and the SSI (1 to 10).

```{r summary of synanthropy index}

head(sp_ssi <- ssi_results[[1]])
```

The second table is a data.frame compiling the effect sizes (effsize) calculated for each comparison of simulated (Null) and observed data, for each species and resolution. The sample sizes for simulated (n1) and observed (n2) data are specified, as well as the magnitude of the effect size (negligible < small < moderate < large) provided by `rstatix::cohens_d`.

```{r effect sizes}

head(effsize_res <- ssi_results [[2]])
``` 

Here we combine these two tables to visualize effect sizes and SSI obtained with the resolution 100.

```{r visualize SSI for resolution 100, fig.width = 10}

# keep only data for resolution 100
# associate the SSI to the detailed effect sizes
sub_effsize_res <- effsize_res %>% 
  filter(Resolution == 100) %>% 
  left_join(sp_ssi, by = c("Species", "Resolution"))

# make the score a factor
sub_effsize_res$Index <- as.factor(sub_effsize_res$Index)

# plot the results
ggplot(sub_effsize_res, 
       aes(x = reorder(Species, -effsize), 
           y = -effsize, fill = Index)) +
  geom_hline(yintercept = 0.0, color = "darkgrey", 
             linewidth = 0.8, linetype = "dashed") +
  geom_boxplot() + 
  coord_flip() +
  scale_fill_brewer(name = "SSI", palette = "RdYlGn") +
  ylab("Effect size") +
  xlab("Species") +
  theme(axis.title.y = element_blank()) +
  theme(legend.position = c(0.9, 0.2)) +
  theme_bw()

```

Based on this plot, we observe that species have contrasted SSI. Epidalea calamita shows high affinity for anthropogenic systems (SSI = 10), followed by Pelodytes punctatus, Triturus marmoratus, and Rana temporaria that all have positive effect sizes.
On the opposite end of the gradient, green frogs (Pelophylax spp. and Pelophylax kl. esculentus) have low synanthropy scores (SSI = 1), and negative effect sizes along with Bufo spinosus. 


### Resolution comparison

It is useful to check whether scores are affected by the level of data aggregation operated during the process. We create a graph that allows the comparison of scores and species ranks across data resolutions.

```{r compare resolutions, fig.width = 10}

sp_ssi$Resolution <- as.factor(sp_ssi$Resolution)

CGPfunctions::newggslopegraph(dataframe = sp_ssi,
                Resolution,
                Index,
                Grouping = Species,
                Title = "Synanthropy scores for amphibian species in western France",
                SubTitle = NULL,
                Caption = NULL)

```

Interestingly, scores are not affected much by the change in data resolution, with unchanged ranks for species with SSI > 4. This suggests that the evaluation is robust to data aggregation.


### Distribution map

Finally, the third table contains all the points simulated and observed. 

```{r points simulated and observed}

head(points <- ssi_results[[3]])
```

We can visualize the locations of observations and of one set of randomly selected sites for each species.

```{r plot distribution map, fig.width = 10}

# we select one resolution, one set of simulated points, and the observed points
sub_points <- points %>% filter(Resolution == "100",
                                simulation %in% c(1, "no"))
table(sub_points)
distri <- sf_transform_xy (distri, 4326, 2154)

ggplot() + 
  geom_point(data = sub_points, aes(x = x, y = y, color = variable), 
             size = 1.5, alpha = 0.5) +
  scale_color_manual(values = c("#ff6600", "#660099")) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  guides(color = guide_legend(title = "Points")) +
  facet_wrap(. ~ Species) +
  theme_void()

```







# 2- Synanthropy Community Score: application of the SSI to amphibian communities in ponds

The scores may then be used at the community scale to estimate the overall sensitivity of assemblages to land use change. These average scores are complementary to anthropisation maps, which must be considered as potential. Indeed, there are cases where the maps present values higher than the scores when sensitive species are not detected, and cases where the maps present values lower than the scores when in reality some populations of sensitive species have maintained themselves locally.

Here we test the scores obtained in the previous section with data of amphibian communities surveyed in western France (around the city of Rennes) between 2000 and 2010.

### Setup

We load the dataset and take a look at it. Its structure is similar to that of the previous dataset, with columns for species names, year, and site of sampling, abundance, and XY coordinates.

```{r load amphibian community data}

ex_com <- read.table(file.path(here::here(), "data", 
                               "amphibiansBrittany", 
                               "Amphibian_community_MNIE.csv"), sep=";", h=T)
head(ex_com)
```

Because not all species were attributed a SSI based on the threshold number applied, we need to check whether some species will not have a SSI in this community.

```{r calculate missing SSI}

# species that are in the community dataset, that are not in the SSI dataset
(unevaluated_species <- setdiff(unique(ex_com$Species), unique(sub_sp_ssi$Species)))

# total number of sites sampled
nsites <- ex_com %>% count(Site) %>% nrow()

# proportion of communities these species are present in
ex_com %>% 
  filter(Species %in% unevaluated_species) %>%
  count(Site) %>% 
  nrow()/ nsites
```

3 species of the community dataset do not have a SSI and they are present in 34% of the studied communities. Community analyses must be interpreted with this caveat in mind.

We then associate previously calculated SSI at resolution 100 to each species, and calculate for each site the species richness, SCS, i.e. the mean of SSI, and SCS, i.e. the SCS weighted by species abundance.

```{r calculate SCS}

ex_com_evaluated <- ex_com %>% inner_join(sub_sp_ssi %>% select(Species, Index))

head(ex_com_sites <- ex_com_evaluated %>%
  group_by(Site, Years, X, Y) %>%
  summarise(Richness = n_distinct(Species),
            SCS = round(mean(Index), 2),
            SCSw = round(weighted.mean(Index, Abundance), 2)))
```

We also calculated the Synanthropy Community Index (SCI), an equivalent of the [Floristic Quality Index](https://esajournals.onlinelibrary.wiley.com/doi/full/10.1002/ecs2.2825) to account for variation of species richness, using the following formula : 

$$
SCI = SCS(√ richness)
$$

```{r calculate SCI}

ex_com_sites %<>% mutate(SCI = round(SCS * sqrt(Richness), 2),
                        SCIw = round(SCSw * sqrt(Richness), 2))

head(ex_com_sites)
```

### Map the results

We can now visualize our new index.

```{r map SCS and SCI, fig.width = 10}

# Create spatial objects
ex_com_map <- sf::st_as_sf(ex_com_sites, coords = c("X", "Y"), crs = 2154)
rast_to_plot2 <- raster::crop(rast_to_plot, ex_com_map)

# Plot the map
ggplot() + 
  tidyterra::geom_spatraster(data = rast_to_plot2, alpha = 0.8) +
  geom_sf(data = ex_com_map, aes(color = SCIw, size = Richness)) +
  scale_colour_gradient(low = "yellow", high = "darkgreen") +
  tidyterra::scale_fill_whitebox_c(palette = "muted", direction=-1) +
  ggtitle("Amphibian communities in ponds") +
  theme(legend.position = "bottom")

```

On this map, the background shows the naturalness index with lower (red) values indicating low naturalness and higher (blue) values indicating high naturalness. Point size represents the amphibian community richness. Lighter green points identify the ponds that have less synanthropic assemblages and are therefore potentially more sensitive to urbanisation and intensified land-use. Darker green points distinguish the ponds presenting rather synanthropic assemblages. 
It is interesting to note that these results contrast in part with the map, with some examples of communities with low SCI scores in areas with low naturalness, illustrating the complementarity of the two approaches.


# References

[Guetté A., Carruthers-Jones J. & Carver S. J. 2021. Projet CARTNAT - Cartographie de la Naturalité. Notice technique, UICN Comité Français, 12 p.]()

[Guetté A., Carruthers-Jones J., Godet L. & Robin M. 2018. « Naturalité » : concepts et méthodes appliqués à la conservation de la nature. Cybergeo: European Journal of Geography, document 856.](https://journals.openedition.org/cybergeo/29140#toc)

[Spyreas G. 2019. Floristic Quality Assessment: a critique, a defense, and a primer. Ecosphere, 10(8): e02825.](https://esajournals.onlinelibrary.wiley.com/doi/full/10.1002/ecs2.2825)

[Zinnen J., Spyreas G., Erdős L., Berg C. & Matthews J.W. 2020. Expert-based measures of human impact to vegetation. Applied Vegetation Science, 24:e12523](https://onlinelibrary.wiley.com/doi/abs/10.1111/avsc.12523)

# Citation

Citations:
* Morel L. 2023. SynAnthrop: Species distribution and sensitivity to anthropisation, R package version 0.1.1, https://github.com/lomorel/SynAnthrop



